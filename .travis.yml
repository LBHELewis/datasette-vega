language: node_js

node_js:
  - "stable"

cache:
  directories:
  - node_modules

script:
  - CI=true npm test

jobs:
  include:
    - stage: deploy datasette-vega-latest.datasette.io
      on: master
      script:
        - npm install -g now
        - REACT_APP_STAGE=dev npm run build
        - echo '{"name":"datasette-vega-latest","alias":"datasette-vega-latest.datasette.io"}' > build/now.json
        - cd build && now --name=datasette-vega-latest --token=$NOW_TOKEN
        - now alias --token=$NOW_TOKEN
    - stage: release tagged version
      if: tag IS present
      language: python
      python: 3.6
      script:
        - pip install -U pip wheel
      deploy:
        - provider: pypi
          user: simonw
          distributions: bdist_wheel
          password:
            secure: dTKntPxKe9MXksoMT3RuCnFrxyI1eDmlKm6D0zWgiNcK1SHDgDzqc8/qV1iaBYaGetXaVzUFd2/Qp3wsSl/PTCKxN1XrHW5xapyqY0+S0qbNczAzRZkiWFK88I3VOg4KwxKbOYZUwya0mUH/PgH1NG9eRnF8cxYiFRo8YUc+7oAoP3jF7PMQxSazR2o9c3+pfhJT+x+edCUyX6qdXN+xos92ssRF3mAAMR2aKoa82i8fFyj10e+atjx39+93tVXbZqTULptDuZb1au0r9B40IDU2vhy7OEcht7W8CnqvZ93V2sJLBcibdiyDIe6aL+6OA3blaBlE2tiYPSijcSfGzCbzExRTbNE0wrc4MM169akGFmdA9HRYrLdvmzKykkopf9ep1cmpHQwdR/iepqtLryQZtSpjCtzunLWx47sY/wCY+CQsKzGNwhZYsC/mjg/XNZRHeIqv9gbPFOEmUA5JTZ/0r5rAtl5DPdyZN/M5WJ+UvGxIiaB/xileoVnivsfqvIm0Hx81rbMZOi9J4gDTYxvrq/pmarDI87wsQ/Sosp8UYsAz+9+aggYr4rdeQOxWVb9jU0qSma+ROw0whEqKZ9gar8PXXeRYVZd/MU5u2CYiTTqzqkGTX4sUeS/rtDVd3melGvOq6yY8REtvo9XP8S0kUtJjuSUV5KHjFB7ihjA=
          on:
            branch: master
            tags: true
            repo: simonw/datasette-vega

