language: node_js

node_js:
  - "stable"

cache:
  directories:
  - node_modules

script:
  - CI=true npm test

jobs:
  include:
    - stage: deploy datasette-vega-latest.datasette.io
      on: master
      script:
        - npm install -g now
        - REACT_APP_STAGE=dev npm run build
        - echo '{"name":"datasette-vega-latest","alias":"datasette-vega-latest.datasette.io"}' > build/now.json
        - cd build && now --name=datasette-vega-latest --token=$NOW_TOKEN
        - now alias --token=$NOW_TOKEN
    - stage: release tagged version
      if: tag IS present
      language: python
      python: 3.6
      script:
        - pip install -U pip wheel
      deploy:
        - provider: pypi
          user: simonw
          distributions: bdist_wheel
          password:
            secure: "n05R72PmilqomYlw25ssAJhmAtG8x/FMQsZVLfZc8tIjQ9DJOqm1GsmDzaBL2BoqyHWUW8ByuCjen+9Tr2Brx02P8YpyGihvdPcf7V7WLVHHWb6dtLDDnmtOqKd7JrbaufO5u7dLf+UzqueRqsTJl58ZgHM6/9QES8GfzQsf6gz+inO7tyg4Ik5imAPVAcmW8y7lSVXrEjamtqgN41+Z07G204hQCE8BdH8unmz6vbhSZ0UdYef6BoCsstby+fx9+l6z6xMzjxPvZkx7LK71ODBLhtLdU+fj0uAZwHNzneV9Zkc+OpINjmc/c1vntZQMdGVqzvbM3QLq8aLjU3c7VhwRNKuhw5I7G60mZ6dg10Mt/zSXKRwrxxPRgReCV2KwzEhT9jmxbFYhkKHNGnlxTwkUYuNS2okFBMC/UQm+VxAqE/pA0aHFAZtsfo+S13ZlqJ5ZYMENHRVL/x8P+v57eQArgZfizsWkDhpV9coKyJXTveOYJ1M7B7CAYnYe/NqmIzItFk3s1wpgXGqITQ9b4QmvyaeQI0m6G0SJqazFWQOnNaF5Oacp+aoNfdGrqUDpTgq6AeYlDmlOgOqV0/2Z4OZmUlN45CDLUyNMFMGFdqjcNJqZBiskZOjbzxqWboxmDwlIneIM6UuwQ5k58KgUXB9iIDPRLDhCJu9roqi8Et0="
          on:
            branch: master
            tags: true
            repo: simonw/datasette-vega

